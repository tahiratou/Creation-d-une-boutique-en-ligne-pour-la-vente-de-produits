@model BoutiqueEnLigne.ViewModels.PaiementViewModel
@using BoutiqueEnLigne.Services

@{
    ViewData["Title"] = "Paiement - DevStore";
}

<div class="container py-4">
    <h1 class="fw-bold mb-4">
        <i class="bi bi-credit-card me-2" style="color: var(--jumia-orange);"></i>Paiement sécurisé
    </h1>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>@TempData["ErrorMessage"]
        </div>
    }

    <div class="row">
        <!-- Formulaire de paiement -->
        <div class="col-lg-7">
            <div class="card shadow-sm mb-4">
                <div class="card-header" style="background-color: var(--jumia-orange); color: white;">
                    <h5 class="mb-0">
                        <i class="bi bi-credit-card me-2"></i>Informations de paiement
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form id="payment-form" asp-action="Traiter" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="stripeToken" id="stripe-token" />
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Nom du détenteur</label>
                            <input type="text" name="nomDetenteur" class="form-control" required
                                   placeholder="Jean Dupont" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Code postal</label>
                            <input type="text" name="codePostal" class="form-control" required
                                   placeholder="H3A 0G4" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Numéro de carte</label>
                            <div id="card-number" class="form-control" style="height: 45px; padding-top: 12px;"></div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Date d'expiration</label>
                                <div id="card-expiry" class="form-control" style="height: 45px; padding-top: 12px;"></div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">CVC</label>
                                <div id="card-cvc" class="form-control" style="height: 45px; padding-top: 12px;"></div>
                            </div>
                        </div>

                        <div id="card-errors" class="text-danger mb-3" role="alert"></div>

                        <!-- Cartes de test -->
                        <div class="alert alert-info alert-static p-3 mb-3">
                            <h6 class="fw-bold mb-2">
                                <i class="bi bi-info-circle me-2"></i>Cartes de test Stripe :
                            </h6>
                            <p class="mb-1"><strong>✅ Succès :</strong> 4242 4242 4242 4242</p>
                            <p class="mb-1"><strong>❌ Refusée :</strong> 4000 0000 0000 0002</p>
                            <p class="mb-0"><small>Date : n'importe quelle date future | CVC : n'importe quel code à 3 chiffres</small></p>
                        </div>

                        <button type="submit" id="submit-btn" class="btn btn-jumia-orange w-100 py-3">
                            <i class="bi bi-lock-fill me-2"></i>
                            PAYER @TranslationService.FormatPrice(Model.MontantTotal)
                        </button>

                        <div class="text-center mt-3">
                            <small class="text-muted">
                                <i class="bi bi-shield-lock me-1"></i>
                                Paiement sécurisé par Stripe - Vos données sont chiffrées
                            </small>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Résumé de la commande -->
        <div class="col-lg-5">
            <div class="card shadow-sm">
                <div class="card-header" style="background-color: var(--jumia-light-gray);">
                    <h5 class="mb-0">Résumé de la commande</h5>
                </div>
                <div class="card-body p-0">
                    @foreach (var article in Model.Articles)
                    {
                        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                            <div>
                                <p class="mb-0 fw-semibold" style="font-size: 0.9rem;">@article.Titre</p>
                                <small class="text-muted">Quantité : @article.Quantite × @TranslationService.FormatPrice(article.PrixUnitaire)</small>
                            </div>
                            <span class="fw-bold">@TranslationService.FormatPrice(article.SousTotal)</span>
                        </div>
                    }
                    <div class="p-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Sous-total</span>
                            <span>@TranslationService.FormatPrice(Model.MontantTotal)</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Livraison</span>
                            <span class="text-success fw-bold">GRATUIT</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold fs-5">Total</span>
                            <span class="fw-bold fs-4" style="color: var(--jumia-orange);">
                                @TranslationService.FormatPrice(Model.MontantTotal)
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const stripe = Stripe('@Model.StripePublishableKey');
        const elements = stripe.elements();

        const style = {
            base: {
                color: '#333',
                fontFamily: 'Segoe UI, sans-serif',
                fontSize: '16px',
                '::placeholder': { color: '#aab7c4' }
            },
            invalid: {
                color: '#dc3545',
                iconColor: '#dc3545'
            }
        };

        const cardNumber = elements.create('cardNumber', { style });
        const cardExpiry = elements.create('cardExpiry', { style });
        const cardCvc = elements.create('cardCvc', { style });

        cardNumber.mount('#card-number');
        cardExpiry.mount('#card-expiry');
        cardCvc.mount('#card-cvc');

        cardNumber.on('change', ({ error }) => {
            document.getElementById('card-errors').textContent = error ? error.message : '';
        });

        const form = document.getElementById('payment-form');
        const submitBtn = document.getElementById('submit-btn');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Traitement en cours...';

            const { token, error } = await stripe.createToken(cardNumber);

            if (error) {
                document.getElementById('card-errors').textContent = error.message;
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-lock-fill me-2"></i>PAYER @TranslationService.FormatPrice(Model.MontantTotal)';
            } else {
                document.getElementById('stripe-token').value = token.id;
                form.submit();
            }
        });
    </script>
}